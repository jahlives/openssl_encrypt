# Minimal test for Docker build functionality
stages:
  - test-docker

variables:
  DOCKER_REGISTRY: $CI_REGISTRY
  DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE/openssl-encrypt-test
  DOCKERFILE_PATH: docker/Dockerfile
  BUILD_CONTEXT: .

test-docker-functionality:
  stage: test-docker
  image: docker:24-dind
  services:
    - name: docker:24-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - until docker info; do sleep 1; done
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY || true
  script:
    # Test 1: Build the image
    - echo "=== Testing Docker Build ==="
    - docker build -f $DOCKERFILE_PATH -t $DOCKER_IMAGE_NAME:test $BUILD_CONTEXT

    # Test 2: Basic functionality
    - echo "=== Testing Basic CLI ==="
    - docker run --rm $DOCKER_IMAGE_NAME:test --help

    # Test 3: PQC support
    - echo "=== Testing PQC Support ==="
    - docker run --rm $DOCKER_IMAGE_NAME:test encrypt --help | grep -E "(kyber|ml-kem|hqc)" || echo "PQC algorithms not found"

    # Test 4: PQC library check
    - echo "=== Testing PQC Library ==="
    - |
      docker run --rm --entrypoint="" $DOCKER_IMAGE_NAME:test python -c "
      try:
          from openssl_encrypt.modules.pqc_liboqs import check_liboqs_support
          available, version, algorithms = check_liboqs_support(quiet=True)
          print(f'✅ PQC Available: {available}, Algorithms: {len(algorithms)}')
      except Exception as e:
          print(f'❌ PQC Test failed: {e}')
      " || echo "PQC test completed with issues"

    # Test 5: Version check
    - echo "=== Testing Version ==="
    - docker run --rm $DOCKER_IMAGE_NAME:test version || echo "Version command not available"

    - echo "✅ All Docker tests completed!"
  rules:
    - when: manual
  allow_failure: true
