default:
  image: python:3.13-alpine
  cache:
    paths:
      - .pip-cache/
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install build twine

stages:
  - build
  - publish

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

build:
  stage: build
  script:
    - python -m build
  artifacts:
    paths:
      - dist/

publish:
  stage: publish
  script:
    - apk add --no-cache curl
    - |
      cat > upload_package.py << 'EOF'
      import os, requests, glob, json
      
      project_id = os.environ.get("CI_PROJECT_ID")
      token = os.environ.get("PROJECT_ACCESS_TOKEN")
      api_url = os.environ.get("CI_API_V4_URL")
      job_token = os.environ.get("CI_JOB_TOKEN")
      
      # Try using the GitLab Job Token approach for PyPI packages
      for pkg in glob.glob("dist/*"):
          print(f"Uploading {pkg}...")
          files = {'file': open(pkg, 'rb')}
          
          # Use multipart/form-data which is what twine would use
          resp = requests.post(
              f"{api_url}/projects/{project_id}/packages/pypi",
              headers={
                  "JOB-TOKEN": job_token
              },
              files=files
          )
          print(f"Upload response for {os.path.basename(pkg)}: {resp.status_code}")
          print(resp.text)
      EOF
    - python upload_package.py
