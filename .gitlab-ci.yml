default:
  image: python:3.13-alpine
  cache:
    paths:
      - .pip-cache/
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install build twine

stages:
  - build
  - publish

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

build:
  stage: build
  script:
    - python -m build
  artifacts:
    paths:
      - dist/

publish:
  stage: publish
  script:
    - apk add --no-cache curl
    - pip install requests
    - |
      cat > upload_package.py << 'EOF'
      import os, requests, glob, json
      
      project_id = os.environ.get("CI_PROJECT_ID")
      token = os.environ.get("PROJECT_ACCESS_TOKEN")
      api_url = os.environ.get("CI_API_V4_URL")
      
      # List packages first to see what's there
      list_resp = requests.get(
          f"{api_url}/projects/{project_id}/packages",
          headers={"PRIVATE-TOKEN": token}
      )
      print(f"Current packages list response: {list_resp.status_code}")
      print(list_resp.text)
      
      # Proper endpoint for PyPI package uploads
      for pkg in glob.glob("dist/*"):
          print(f"Uploading {pkg}...")
          with open(pkg, "rb") as f:
              if pkg.endswith(".whl"):
                  filename = os.path.basename(pkg)
                  resp = requests.put(
                      f"{api_url}/projects/{project_id}/packages/pypi/files/{filename}",
                      headers={"PRIVATE-TOKEN": token},
                      data=f
                  )
                  print(f"Upload response: {resp.status_code}")
                  print(resp.text)
      EOF
    - python upload_package.py
