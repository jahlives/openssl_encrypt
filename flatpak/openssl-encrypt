#!/usr/bin/env python3
"""
Launcher script for OpenSSL Encrypt Flatpak package.
Handles both CLI and GUI modes based on command line arguments.
"""

import os
import sys
import subprocess
import signal
import atexit

# Add the application directory to Python path
app_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, app_dir)

# Global variable to track Xvfb process
_xvfb_process = None

def cleanup_xvfb():
    """Clean up Xvfb process on exit."""
    global _xvfb_process
    if _xvfb_process and _xvfb_process.poll() is None:
        print("üßπ Cleaning up virtual display (Xvfb)...")
        try:
            _xvfb_process.terminate()
            _xvfb_process.wait(timeout=5)
        except (subprocess.TimeoutExpired, OSError):
            try:
                _xvfb_process.kill()
                _xvfb_process.wait(timeout=2)
            except (subprocess.TimeoutExpired, OSError):
                pass
        _xvfb_process = None

def setup_xvfb_if_needed():
    """Setup Xvfb virtual display if needed for tkinter in Flatpak+Wayland."""
    global _xvfb_process
    
    wayland_display = os.environ.get("WAYLAND_DISPLAY")
    x11_display = os.environ.get("DISPLAY")
    
    # Check if we're in Wayland without X11 display
    if wayland_display and not x11_display:
        print(f"üîß Detected Wayland environment ({wayland_display}) without X11 display")
        print("üîß Setting up virtual display (Xvfb) for tkinter compatibility...")
        
        try:
            # Start Xvfb on display :99
            _xvfb_process = subprocess.Popen(
                ['Xvfb', ':99', '-screen', '0', '1024x768x24', '-nolisten', 'tcp'],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.PIPE
            )
            
            # Wait a moment for Xvfb to start
            import time
            time.sleep(1)
            
            # Check if Xvfb started successfully
            if _xvfb_process.poll() is None:
                os.environ["DISPLAY"] = ":99"
                print("‚úÖ Virtual display started successfully (DISPLAY=:99)")
                # Register cleanup
                atexit.register(cleanup_xvfb)
                signal.signal(signal.SIGTERM, lambda s, f: cleanup_xvfb())
                signal.signal(signal.SIGINT, lambda s, f: cleanup_xvfb())
            else:
                # Xvfb failed to start
                stderr_output = _xvfb_process.stderr.read().decode() if _xvfb_process.stderr else "Unknown error"
                print(f"‚ö†Ô∏è  Virtual display setup failed: {stderr_output}")
                _xvfb_process = None
                
        except (FileNotFoundError, OSError) as e:
            print(f"‚ö†Ô∏è  Xvfb not available in Flatpak environment: {e}")
            print("üí° Falling back to Wayland-compatible options...")
            _xvfb_process = None

def main():
    """Main launcher function."""
    # Check if GUI mode is requested
    if len(sys.argv) > 1 and "--gui" in sys.argv:
        # Remove --gui from arguments to avoid conflicts
        sys.argv = [arg for arg in sys.argv if arg != "--gui"]

        # Check for explicit GUI type flags
        force_tkinter = "--gui-tk" in sys.argv
        if force_tkinter:
            sys.argv = [arg for arg in sys.argv if arg != "--gui-tk"]

        # Try Flutter GUI first (preferred for Flatpak)
        flutter_gui_path = "/app/bin/openssl-encrypt-gui/openssl_encrypt_mobile"
        if not force_tkinter and os.path.exists(flutter_gui_path):
            print("üöÄ Launching Flutter desktop GUI...")
            try:
                # Run the Flutter executable directly with clean environment
                result = subprocess.run([flutter_gui_path], env=os.environ.copy())
                sys.exit(result.returncode)
            except Exception as e:
                print(f"‚ùå Flutter GUI launch failed: {e}", file=sys.stderr)
                if not force_tkinter:
                    print("üîÑ Falling back to tkinter GUI...", file=sys.stderr)
                # Continue to tkinter GUI below
        elif not force_tkinter:
            print("‚ö†Ô∏è  Flutter GUI not available - using tkinter GUI fallback")
        
        # Launch tkinter GUI (explicit request, fallback, or when Flutter not available)
        print("üéØ Launching tkinter GUI...")
        
        # Setup Xvfb if needed for Wayland environments
        setup_xvfb_if_needed()
        
        try:
            # Check display environment

            print(f"DISPLAY environment: {os.environ.get('DISPLAY', 'NOT SET')}")
            print(f"WAYLAND_DISPLAY environment: {os.environ.get('WAYLAND_DISPLAY', 'NOT SET')}")
            print(f"XAUTHORITY environment: {os.environ.get('XAUTHORITY', 'NOT SET')}")
            print(
                f"Available display vars: {sorted([k for k in os.environ.keys() if 'DISPLAY' in k.upper() or 'WAYLAND' in k.upper() or 'AUTH' in k.upper()])}"
            )
            print(f"X11 socket exists: {os.path.exists('/tmp/.X11-unix/X0')}")

            # Try to force set environment from command line args
            for arg in sys.argv:
                if arg.startswith("--env=DISPLAY="):
                    display_val = arg.split("=", 2)[2]
                    os.environ["DISPLAY"] = display_val
                    print(f"Set DISPLAY from command line: {display_val}")
                    break

            # First check if tkinter is available
            import tkinter

            print("‚úì tkinter is available")

            # Handle Wayland vs X11 display setup
            wayland_display = os.environ.get("WAYLAND_DISPLAY")
            x11_display = os.environ.get("DISPLAY")

            if wayland_display:
                # Wayland environment - remove X11 auth that's causing issues
                print(f"Detected Wayland environment: {wayland_display}")
                os.environ["GDK_BACKEND"] = "wayland,x11"
                # Remove XAUTHORITY to avoid auth issues in Flatpak
                if "XAUTHORITY" in os.environ:
                    del os.environ["XAUTHORITY"]
                print("Using Wayland with X11 fallback (no X11 auth)")
            elif x11_display:
                print(f"Using X11 display: {x11_display}")
                os.environ["GDK_BACKEND"] = "x11"
            else:
                # No display detected - try automatic detection
                print("WARNING: No display server detected")
                print("Using automatic display detection...")
                os.environ["GDK_BACKEND"] = "wayland,x11"

            print(f"Final DISPLAY: {os.environ.get('DISPLAY')}")
            print(f"Final XAUTHORITY: {os.environ.get('XAUTHORITY')}")

            # Skip display test - let the GUI handle display connection directly
            print("Skipping display test - letting GUI handle connection directly")

            # Then try to import the GUI module
            from openssl_encrypt.crypt_gui import main as gui_main

            print("‚úì GUI module imported successfully")

            # Font configuration will be handled by the GUI itself
            gui_main()
        except ImportError as e:
            print(f"‚ùå Error: GUI components not available - {e}", file=sys.stderr)
            print("Python path:", sys.path, file=sys.stderr)

            # Try to give more specific error information
            try:
                import tkinter
                print("‚úì tkinter is available, issue is with openssl_encrypt module", file=sys.stderr)
            except ImportError:
                print("‚úó tkinter is not available", file=sys.stderr)

            # If --gui-tk was explicitly requested and failed, try Flutter fallback
            if force_tkinter and os.path.exists(flutter_gui_path):
                print("üîÑ tkinter GUI failed, attempting Flutter GUI fallback...", file=sys.stderr)
                try:
                    import subprocess
                    result = subprocess.run([flutter_gui_path], env=os.environ.copy())
                    sys.exit(result.returncode)
                except Exception as flutter_error:
                    print(f"‚ùå Flutter GUI fallback also failed: {flutter_error}", file=sys.stderr)
            
            sys.exit(1)
        except Exception as e:
            print(f"‚ùå Error launching tkinter GUI: {e}", file=sys.stderr)
            
            # If --gui-tk was explicitly requested and failed, try Flutter fallback
            if force_tkinter and os.path.exists(flutter_gui_path):
                print("üîÑ tkinter GUI failed, attempting Flutter GUI fallback...", file=sys.stderr)
                try:
                    import subprocess
                    result = subprocess.run([flutter_gui_path], env=os.environ.copy())
                    sys.exit(result.returncode)
                except Exception as flutter_error:
                    print(f"‚ùå Flutter GUI fallback also failed: {flutter_error}", file=sys.stderr)
            
            sys.exit(1)
    else:
        # Launch CLI
        try:
            from openssl_encrypt.cli import main as cli_main

            cli_main()
        except ImportError:
            print("Error: CLI components not available", file=sys.stderr)
            sys.exit(1)


if __name__ == "__main__":
    main()
