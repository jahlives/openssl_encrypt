#!/usr/bin/env python3
import os

# Force set environment variables at the very start
os.environ["DISPLAY"] = ":0"
os.environ["XAUTHORITY"] = "/run/user/1000/xauth_PaSUjl"
"""
Launcher script for OpenSSL Encrypt Flatpak package.
Handles both CLI and GUI modes based on command line arguments.
"""

import os
import sys

# Add the application directory to Python path
app_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, app_dir)


def main():
    """Main launcher function."""
    # Check if GUI mode is requested
    if len(sys.argv) > 1 and "--gui" in sys.argv:
        # Remove --gui from arguments to avoid conflicts
        sys.argv = [arg for arg in sys.argv if arg != "--gui"]

        # Launch GUI
        try:
            # Check display environment
            import os

            print(f"DISPLAY environment: {os.environ.get('DISPLAY', 'NOT SET')}")
            print(f"WAYLAND_DISPLAY environment: {os.environ.get('WAYLAND_DISPLAY', 'NOT SET')}")
            print(f"XAUTHORITY environment: {os.environ.get('XAUTHORITY', 'NOT SET')}")
            print(
                f"Available display vars: {sorted([k for k in os.environ.keys() if 'DISPLAY' in k.upper() or 'WAYLAND' in k.upper() or 'AUTH' in k.upper()])}"
            )
            print(f"X11 socket exists: {os.path.exists('/tmp/.X11-unix/X0')}")

            # Try to force set environment from command line args
            for arg in sys.argv:
                if arg.startswith("--env=DISPLAY="):
                    display_val = arg.split("=", 2)[2]
                    os.environ["DISPLAY"] = display_val
                    print(f"Set DISPLAY from command line: {display_val}")
                    break

            # First check if tkinter is available
            import tkinter

            print("✓ tkinter is available")

            # Handle Wayland vs X11 display setup
            wayland_display = os.environ.get("WAYLAND_DISPLAY")
            x11_display = os.environ.get("DISPLAY")

            if wayland_display and not x11_display:
                # Pure Wayland environment - tkinter should work through XWayland
                print(f"Detected Wayland environment: {wayland_display}")
                # Don't force X11 settings, let tkinter use XWayland
            elif x11_display:
                print(f"Using X11 display: {x11_display}")
            else:
                # Fallback to X11
                os.environ["DISPLAY"] = ":0"
                print("Fallback: Force setting DISPLAY to :0")

            # Only set XAUTHORITY if we're using X11
            if os.environ.get("DISPLAY") and not os.environ.get("XAUTHORITY"):
                os.environ["XAUTHORITY"] = "/run/user/1000/xauth_PaSUjl"
                print("Setting XAUTHORITY for X11")

            print(f"Final DISPLAY: {os.environ.get('DISPLAY')}")
            print(f"Final XAUTHORITY: {os.environ.get('XAUTHORITY')}")

            # Test if we can create a simple tkinter window
            try:
                test_root = tkinter.Tk()
                test_root.withdraw()
                test_root.destroy()
                print("✓ tkinter display connection successful")
            except Exception as e:
                print(f"✗ tkinter display connection failed: {e}")
                print("This indicates an issue with display server access in the Flatpak sandbox")

                # Try to provide helpful debugging info
                if wayland_display and not x11_display:
                    print("Wayland detected - tkinter needs XWayland for compatibility")
                    print("Make sure XWayland is installed and running")
                elif x11_display:
                    print(f"X11 detected but connection to {x11_display} failed")
                    print("Check X11 permissions and that display server is running")
                else:
                    print("No display server detected")

                raise Exception(f"Cannot connect to display server: {e}")

            # Then try to import the GUI module
            from openssl_encrypt.crypt_gui import main as gui_main

            print("✓ GUI module imported successfully")

            gui_main()
        except ImportError as e:
            print(f"Error: GUI components not available - {e}", file=sys.stderr)
            print("Python path:", sys.path, file=sys.stderr)

            # Try to give more specific error information
            try:
                import tkinter

                print(
                    "✓ tkinter is available, issue is with openssl_encrypt module", file=sys.stderr
                )
            except ImportError:
                print("✗ tkinter is not available", file=sys.stderr)

            sys.exit(1)
    else:
        # Launch CLI
        try:
            from openssl_encrypt.cli import main as cli_main

            cli_main()
        except ImportError:
            print("Error: CLI components not available", file=sys.stderr)
            sys.exit(1)


if __name__ == "__main__":
    main()
